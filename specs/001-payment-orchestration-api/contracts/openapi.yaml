openapi: 3.0.3
info:
  title: PayTrust Payment Orchestration API
  description: |
    PayTrust is a payment orchestration platform that unifies multiple payment gateways 
    (Xendit and Midtrans) through a RESTful API. The system enables developers to create 
    invoices with line items, manage installment payments, apply taxes and service fees, 
    and maintain strict currency isolation.
  version: 1.0.0
  contact:
    name: PayTrust API Support
    email: api@paytrust.example.com

servers:
  - url: https://api.paytrust.example.com/v1
    description: Production server
  - url: https://sandbox-api.paytrust.example.com/v1
    description: Sandbox server

security:
  - ApiKeyAuth: []

paths:
  /invoices:
    post:
      summary: Create a new invoice
      description: |
        Creates a new invoice with line items, taxes, and optional installment plan.
        Returns invoice ID and payment URL(s).
      operationId: createInvoice
      tags:
        - Invoices
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInvoiceRequest'
            examples:
              singlePayment:
                summary: Single payment invoice
                value:
                  currency: "IDR"
                  gateway_id: "gateway-xendit-123"
                  line_items:
                    - product_name: "Premium Subscription"
                      quantity: 1
                      unit_price: "1000000"
                      tax_rate: "0.10"
                  expires_at: "2025-11-02T10:00:00Z"
              installmentPayment:
                summary: Invoice with 3 installments
                value:
                  currency: "IDR"
                  gateway_id: "gateway-xendit-123"
                  line_items:
                    - product_name: "Laptop"
                      quantity: 1
                      unit_price: "10000000"
                      tax_rate: "0.10"
                  installments:
                    count: 3
                    custom_amounts:
                      - "2000000"
                      - "3000000"
                      - "6100000"
      responses:
        '201':
          description: Invoice created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    get:
      summary: List invoices
      description: Returns a paginated list of invoices for the authenticated merchant
      operationId: listInvoices
      tags:
        - Invoices
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/InvoiceStatus'
          description: Filter by invoice status
        - name: currency
          in: query
          schema:
            $ref: '#/components/schemas/Currency'
          description: Filter by currency
      responses:
        '200':
          description: List of invoices
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/InvoiceResponse'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /invoices/{invoice_id}:
    get:
      summary: Get invoice details
      description: Returns detailed information about a specific invoice
      operationId: getInvoice
      tags:
        - Invoices
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Invoice details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /invoices/{invoice_id}/installments:
    get:
      summary: Get installment schedule
      description: Returns the installment schedule for an invoice
      operationId: getInstallments
      tags:
        - Installments
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Installment schedule
          content:
            application/json:
              schema:
                type: object
                properties:
                  invoice_id:
                    type: string
                    format: uuid
                  installments:
                    type: array
                    items:
                      $ref: '#/components/schemas/InstallmentResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Adjust unpaid installment amounts
      description: |
        Adjusts unpaid installment amounts while maintaining total invoice amount.
        Only unpaid installments can be modified (FR-077, FR-078).
      operationId: adjustInstallments
      tags:
        - Installments
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                installments:
                  type: array
                  items:
                    type: object
                    properties:
                      installment_number:
                        type: integer
                        minimum: 1
                      new_amount:
                        type: string
                        pattern: '^\d+(\.\d{1,4})?$'
                    required:
                      - installment_number
                      - new_amount
              required:
                - installments
            example:
              installments:
                - installment_number: 2
                  new_amount: "4000000"
                - installment_number: 3
                  new_amount: "5100000"
      responses:
        '200':
          description: Installments adjusted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  invoice_id:
                    type: string
                    format: uuid
                  installments:
                    type: array
                    items:
                      $ref: '#/components/schemas/InstallmentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /invoices/{invoice_id}/transactions:
    get:
      summary: Get payment transactions
      description: Returns all payment transactions for an invoice
      operationId: getTransactions
      tags:
        - Transactions
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Payment transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  invoice_id:
                    type: string
                    format: uuid
                  transactions:
                    type: array
                    items:
                      $ref: '#/components/schemas/TransactionResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /invoices/{invoice_id}/reconciliation:
    get:
      summary: Get payment discrepancies
      description: |
        Returns payment discrepancies for invoices with partial payments (FR-050).
        Shows overpayments or underpayments that need merchant attention.
      operationId: getReconciliation
      tags:
        - Transactions
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Reconciliation data
          content:
            application/json:
              schema:
                type: object
                properties:
                  invoice_id:
                    type: string
                    format: uuid
                  total_amount:
                    type: string
                  amount_paid:
                    type: string
                  difference:
                    type: string
                    description: Positive for overpayment, negative for underpayment
                  status:
                    type: string
                    enum: [exact_match, overpaid, underpaid]
                  transactions:
                    type: array
                    items:
                      $ref: '#/components/schemas/TransactionResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /webhooks/{gateway_name}:
    post:
      summary: Payment gateway webhook
      description: |
        Receives webhook notifications from payment gateways (Xendit, Midtrans).
        Validates signature and processes payment status updates.
      operationId: handleWebhook
      tags:
        - Webhooks
      security: []  # No API key, uses webhook signature
      parameters:
        - name: gateway_name
          in: path
          required: true
          schema:
            type: string
            enum: [xendit, midtrans]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Gateway-specific payload (varies by gateway)
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "received"
        '401':
          description: Invalid webhook signature
        '500':
          description: Processing error (gateway will retry)

  /reports/financial:
    get:
      summary: Get financial report
      description: |
        Returns aggregated financial data including service fees and taxes by 
        currency, gateway, and tax rate (FR-063, FR-064).
      operationId: getFinancialReport
      tags:
        - Reports
      parameters:
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date
          example: "2025-01-01"
        - name: end_date
          in: query
          required: true
          schema:
            type: string
            format: date
          example: "2025-01-31"
        - name: currency
          in: query
          schema:
            $ref: '#/components/schemas/Currency'
          description: Filter by specific currency
      responses:
        '200':
          description: Financial report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FinancialReportResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /gateways:
    get:
      summary: List available payment gateways
      description: Returns list of configured payment gateways with supported currencies
      operationId: listGateways
      tags:
        - Gateways
      responses:
        '200':
          description: List of payment gateways
          content:
            application/json:
              schema:
                type: object
                properties:
                  gateways:
                    type: array
                    items:
                      $ref: '#/components/schemas/GatewayResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication (FR-033)

  parameters:
    InvoiceId:
      name: invoice_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Invoice unique identifier

    Page:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
      description: Page number for pagination

    PageSize:
      name: page_size
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      description: Number of items per page

  schemas:
    Currency:
      type: string
      enum: [IDR, MYR, USD]
      description: Supported currencies (FR-002)

    InvoiceStatus:
      type: string
      enum: [draft, pending, partially_paid, paid, failed, expired]
      description: Invoice status (FR-029)

    CreateInvoiceRequest:
      type: object
      required:
        - currency
        - gateway_id
        - line_items
      properties:
        currency:
          $ref: '#/components/schemas/Currency'
        gateway_id:
          type: string
          format: uuid
          description: Selected payment gateway (FR-007)
        line_items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - product_name
              - quantity
              - unit_price
              - tax_rate
            properties:
              product_name:
                type: string
                maxLength: 255
              quantity:
                type: string
                pattern: '^\d+(\.\d{1,2})?$'
                description: Decimal quantity
              unit_price:
                type: string
                pattern: '^\d+(\.\d{1,4})?$'
                description: Price per unit
              tax_rate:
                type: string
                pattern: '^0(\.\d{1,4})?$|^1(\.0{1,4})?$'
                description: Tax rate as decimal (0.10 = 10%)
              tax_category:
                type: string
                maxLength: 50
                description: Optional tax category
        installments:
          type: object
          description: Optional installment configuration (FR-014)
          properties:
            count:
              type: integer
              minimum: 2
              maximum: 12
              description: Number of installments
            custom_amounts:
              type: array
              description: Optional custom amounts (must sum to total)
              items:
                type: string
                pattern: '^\d+(\.\d{1,4})?$'
        expires_at:
          type: string
          format: date-time
          description: Invoice expiration (default 24h from creation, FR-044)
        metadata:
          type: object
          additionalProperties: true
          description: Optional custom metadata

    InvoiceResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        merchant_id:
          type: string
          format: uuid
        currency:
          $ref: '#/components/schemas/Currency'
        subtotal:
          type: string
          description: Sum of line item subtotals
        tax_total:
          type: string
          description: Total taxes from all line items
        service_fee:
          type: string
          description: Payment gateway service fee
        total_amount:
          type: string
          description: subtotal + tax_total + service_fee (FR-056)
        status:
          $ref: '#/components/schemas/InvoiceStatus'
        gateway:
          $ref: '#/components/schemas/GatewayResponse'
        payment_url:
          type: string
          format: uri
          description: Payment link (or first installment link)
        is_immutable:
          type: boolean
          description: Locked after payment initiation (FR-051)
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        line_items:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              product_name:
                type: string
              quantity:
                type: string
              unit_price:
                type: string
              subtotal:
                type: string
              tax_rate:
                type: string
              tax_amount:
                type: string
        installments:
          type: array
          items:
            $ref: '#/components/schemas/InstallmentResponse'

    InstallmentResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        installment_number:
          type: integer
        amount:
          type: string
        tax_amount:
          type: string
          description: Proportionally distributed (FR-059)
        service_fee_amount:
          type: string
          description: Proportionally distributed (FR-060)
        due_date:
          type: string
          format: date
        status:
          type: string
          enum: [unpaid, paid, overdue]
        payment_url:
          type: string
          format: uri
          nullable: true
          description: Available only for next unpaid installment (FR-069)
        gateway_reference:
          type: string
          nullable: true
        paid_at:
          type: string
          format: date-time
          nullable: true

    TransactionResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        invoice_id:
          type: string
          format: uuid
        installment_id:
          type: string
          format: uuid
          nullable: true
        gateway_transaction_ref:
          type: string
        amount_paid:
          type: string
        payment_method:
          type: string
        status:
          type: string
          enum: [pending, completed, failed, refunded]
        created_at:
          type: string
          format: date-time

    FinancialReportResponse:
      type: object
      properties:
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        service_fees:
          type: array
          items:
            type: object
            properties:
              currency:
                $ref: '#/components/schemas/Currency'
              gateway:
                type: string
              total_amount:
                type: string
              transaction_count:
                type: integer
        taxes:
          type: array
          description: Tax breakdown by rate and currency (FR-063, FR-064)
          items:
            type: object
            properties:
              currency:
                $ref: '#/components/schemas/Currency'
              tax_rate:
                type: string
              total_amount:
                type: string
              transaction_count:
                type: integer

    GatewayResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          enum: [xendit, midtrans]
        supported_currencies:
          type: array
          items:
            $ref: '#/components/schemas/Currency'
        is_active:
          type: boolean

    Pagination:
      type: object
      properties:
        current_page:
          type: integer
        page_size:
          type: integer
        total_items:
          type: integer
        total_pages:
          type: integer

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              additionalProperties: true

  responses:
    BadRequest:
      description: Bad request (validation error)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "VALIDATION_ERROR"
              message: "Invalid request parameters"
              details:
                field: "line_items[0].quantity"
                issue: "must be greater than 0"

    Unauthorized:
      description: Unauthorized (invalid or missing API key, FR-037)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "UNAUTHORIZED"
              message: "Invalid or missing API key"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "NOT_FOUND"
              message: "Invoice not found"

    TooManyRequests:
      description: Rate limit exceeded (FR-041)
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds until rate limit resets
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "RATE_LIMIT_EXCEEDED"
              message: "Rate limit of 1000 requests per minute exceeded"
