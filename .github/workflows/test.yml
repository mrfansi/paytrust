name: Test Suite

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "fix/**"
  pull_request:
    branches:
      - main
      - develop

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: paytrust_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.91.0
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features mysql

      - name: Wait for MySQL to be ready
        run: |
          until mysqladmin ping -h 127.0.0.1 -u root -ptest_password --silent; do
            echo "Waiting for MySQL..."
            sleep 2
          done
          echo "MySQL is ready!"

      - name: Run database migrations
        env:
          DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/paytrust_test
        run: sqlx migrate run

      - name: Seed test data
        env:
          DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/paytrust_test
        run: |
          # Insert test payment gateways
          mysql -h 127.0.0.1 -u root -ptest_password paytrust_test <<EOF
          INSERT INTO payment_gateways (id, name, provider, base_url, is_active, created_at, updated_at)
          VALUES 
            ('xendit-test-001', 'Xendit Test', 'xendit', 'https://api.xendit.co', 1, NOW(), NOW()),
            ('midtrans-test-001', 'Midtrans Test', 'midtrans', 'https://api.sandbox.midtrans.com', 1, NOW(), NOW())
          ON DUPLICATE KEY UPDATE updated_at = NOW();
          EOF

      - name: Run unit tests
        env:
          TEST_DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/paytrust_test
          DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/paytrust_test
          SERVER_HOST: 127.0.0.1
          SERVER_PORT: 8080
          RUST_LOG: info
          XENDIT_TEST_API_KEY: ${{ secrets.XENDIT_TEST_API_KEY }}
          MIDTRANS_SERVER_KEY: ${{ secrets.MIDTRANS_SERVER_KEY }}
          TEST_CLEANUP_ENABLED: true
        run: cargo test --lib --verbose

      - name: Run integration tests
        env:
          TEST_DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/paytrust_test
          DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/paytrust_test
          SERVER_HOST: 127.0.0.1
          SERVER_PORT: 8080
          RUST_LOG: info
          XENDIT_TEST_API_KEY: ${{ secrets.XENDIT_TEST_API_KEY }}
          MIDTRANS_SERVER_KEY: ${{ secrets.MIDTRANS_SERVER_KEY }}
          TEST_CLEANUP_ENABLED: true
        run: cargo test --test '*' --verbose

      - name: Run contract tests
        env:
          TEST_DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/paytrust_test
          DATABASE_URL: mysql://root:test_password@127.0.0.1:3306/paytrust_test
          SERVER_HOST: 127.0.0.1
          SERVER_PORT: 8080
          RUST_LOG: info
        run: cargo test --test '*api_test' --verbose

      - name: Check code formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
